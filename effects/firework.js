/**
 * Fireworks Effect Library
 * T√°ch t·ª´ heart-beat.html ƒë·ªÉ s·ª≠ d·ª•ng ƒë·ªôc l·∫≠p
 * 
 * C√°ch s·ª≠ d·ª•ng:
 * 1. Include file n√†y v√†o HTML
 * 2. T·∫°o canvas element v·ªõi id="fireworks-canvas"
 * 3. G·ªçi FireworksEffect.init() ƒë·ªÉ kh·ªüi t·∫°o
 * 4. S·ª≠ d·ª•ng c√°c method ƒë·ªÉ ƒëi·ªÅu khi·ªÉn hi·ªáu ·ª©ng
 */

class FireworksEffect {
    constructor() {
        this.canvas = null;
        this.ctx = null;
        this.fireworks = [];
        this.maxFireworks = 5;
        this.isInitialized = false;
        this.animationId = null;
        this.autoCreateInterval = null;
        this.width = 0;
        this.height = 0;
    }

    /**
     * Kh·ªüi t·∫°o hi·ªáu ·ª©ng ph√°o hoa
     * @param {string} canvasId - ID c·ªßa canvas element
     * @param {Object} options - C√°c t√πy ch·ªçn c·∫•u h√¨nh
     */
    init(canvasId = 'fireworks-canvas', options = {}) {
        this.canvas = document.getElementById(canvasId);
        if (!this.canvas) {
            console.error('Canvas element not found with id:', canvasId);
            return false;
        }

        this.ctx = this.canvas.getContext('2d');
        this.width = this.canvas.width = window.innerWidth;
        this.height = this.canvas.height = window.innerHeight;

        // C·∫•u h√¨nh m·∫∑c ƒë·ªãnh
        this.maxFireworks = options.maxFireworks || 5;
        this.autoCreate = options.autoCreate !== false; // M·∫∑c ƒë·ªãnh b·∫≠t
        this.autoCreateInterval = options.autoCreateInterval || 2000; // 2 gi√¢y
        this.particleCount = options.particleCount || { min: 15, max: 25 };
        this.particleSpeed = options.particleSpeed || { min: 2, max: 5 };
        this.particleSize = options.particleSize || { min: 2, max: 6 };
        this.colors = options.colors || ['hsl(320, 80%, 70%)', 'hsl(340, 80%, 70%)', 'hsl(0, 80%, 70%)', 'hsl(20, 80%, 70%)'];

        this.isInitialized = true;

        // B·∫Øt ƒë·∫ßu animation loop
        this.startAnimation();

        // B·∫Øt ƒë·∫ßu t·ª± ƒë·ªông t·∫°o ph√°o hoa
        if (this.autoCreate) {
            this.startAutoCreate();
        }

        // X·ª≠ l√Ω resize window
        window.addEventListener('resize', () => this.handleResize());

        console.log('üéÜ Fireworks effect initialized successfully');
        return true;
    }

    /**
     * B·∫Øt ƒë·∫ßu animation loop
     */
    startAnimation() {
        if (!this.isInitialized) return;

        const animate = () => {
            this.update();
            this.draw();
            this.animationId = requestAnimationFrame(animate);
        };

        animate();
    }

    /**
     * D·ª´ng animation
     */
    stopAnimation() {
        if (this.animationId) {
            cancelAnimationFrame(this.animationId);
            this.animationId = null;
        }
    }

    /**
     * B·∫Øt ƒë·∫ßu t·ª± ƒë·ªông t·∫°o ph√°o hoa
     */
    startAutoCreate() {
        this.autoCreateInterval = setInterval(() => {
            if (this.fireworks.length < this.maxFireworks - 1) {
                // T·∫°o 2 ph√°o hoa c√πng l√∫c ·ªü v·ªã tr√≠ kh√°c nhau
                const x1 = Math.random() * this.width;
                const y1 = Math.random() * this.height * 0.6; // 60% tr√™n c√πng
                this.createFirework(x1, y1);

                const x2 = Math.random() * this.width;
                const y2 = Math.random() * this.height * 0.6;
                this.createFirework(x2, y2);
            }
        }, this.autoCreateInterval);
    }

    /**
     * D·ª´ng t·ª± ƒë·ªông t·∫°o ph√°o hoa
     */
    stopAutoCreate() {
        if (this.autoCreateInterval) {
            clearInterval(this.autoCreateInterval);
            this.autoCreateInterval = null;
        }
    }

    /**
     * T·∫°o ph√°o hoa t·∫°i v·ªã tr√≠ c·ª• th·ªÉ
     * @param {number} x - T·ªça ƒë·ªô X
     * @param {number} y - T·ªça ƒë·ªô Y
     * @param {Object} options - T√πy ch·ªçn cho ph√°o hoa c·ª• th·ªÉ
     */
    createFirework(x, y, options = {}) {
        const particleCount = options.particleCount || 
            (this.particleCount.min + Math.floor(Math.random() * (this.particleCount.max - this.particleCount.min)));
        
        const particles = [];

        for (let i = 0; i < particleCount; i++) {
            const angle = (Math.PI * 2 * i) / particleCount + Math.random() * 0.5;
            const speed = options.speed || 
                (this.particleSpeed.min + Math.random() * (this.particleSpeed.max - this.particleSpeed.min));
            const size = options.size || 
                (this.particleSize.min + Math.random() * (this.particleSize.max - this.particleSize.min));

            particles.push({
                x: x,
                y: y,
                vx: Math.cos(angle) * speed,
                vy: Math.sin(angle) * speed,
                size: size,
                alpha: 1,
                life: 1,
                decay: Math.random() * 0.02 + 0.015,
                hue: options.hue || (Math.random() * 40 + 320), // Pink to red range
                gravity: options.gravity || 0.1,
                trail: []
            });
        }

        this.fireworks.push({
            x: x,
            y: y,
            particles: particles,
            life: 1,
            decay: 0.01
        });
    }

    /**
     * T·∫°o ph√°o hoa t·∫°i v·ªã tr√≠ chu·ªôt
     * @param {MouseEvent} event - S·ª± ki·ªán chu·ªôt
     */
    createFireworkAtMouse(event) {
        const rect = this.canvas.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;
        this.createFirework(x, y);
    }

    /**
     * C·∫≠p nh·∫≠t tr·∫°ng th√°i c√°c ph√°o hoa
     */
    update() {
        // C·∫≠p nh·∫≠t t·ª´ng ph√°o hoa
        for (let i = this.fireworks.length - 1; i >= 0; i--) {
            const firework = this.fireworks[i];

            // C·∫≠p nh·∫≠t t·ª´ng particle
            for (let j = firework.particles.length - 1; j >= 0; j--) {
                const particle = firework.particles[j];

                // C·∫≠p nh·∫≠t v·ªã tr√≠
                particle.x += particle.vx;
                particle.y += particle.vy;
                particle.vy += particle.gravity;

                // Th√™m v√†o trail
                particle.trail.push({ x: particle.x, y: particle.y });
                if (particle.trail.length > 5) {
                    particle.trail.shift();
                }

                // C·∫≠p nh·∫≠t life
                particle.life -= particle.decay;
                particle.alpha = particle.life;

                // X√≥a particle n·∫øu h·∫øt life
                if (particle.life <= 0) {
                    firework.particles.splice(j, 1);
                }
            }

            // X√≥a ph√°o hoa n·∫øu h·∫øt particles
            if (firework.particles.length === 0) {
                this.fireworks.splice(i, 1);
            }
        }
    }

    /**
     * V·∫Ω c√°c ph√°o hoa l√™n canvas
     */
    draw() {
        // X√≥a canvas
        this.ctx.clearRect(0, 0, this.width, this.height);

        // V·∫Ω t·ª´ng ph√°o hoa
        for (let i = 0; i < this.fireworks.length; i++) {
            const firework = this.fireworks[i];

            // V·∫Ω t·ª´ng particle
            for (let j = 0; j < firework.particles.length; j++) {
                const particle = firework.particles[j];

                // V·∫Ω trail
                this.ctx.save();
                this.ctx.globalAlpha = particle.alpha * 0.3;
                this.ctx.strokeStyle = `hsl(${particle.hue}, 80%, 70%)`;
                this.ctx.lineWidth = 1;
                this.ctx.beginPath();
                for (let k = 0; k < particle.trail.length - 1; k++) {
                    this.ctx.moveTo(particle.trail[k].x, particle.trail[k].y);
                    this.ctx.lineTo(particle.trail[k + 1].x, particle.trail[k + 1].y);
                }
                this.ctx.stroke();
                this.ctx.restore();

                // V·∫Ω particle (h√¨nh tr√°i tim)
                if (particle.life > 0) {
                    this.drawHeartParticle(particle.x, particle.y, particle.size, particle.alpha, particle.hue);
                }
            }
        }
    }

    /**
     * V·∫Ω particle h√¨nh tr√°i tim
     * @param {number} x - T·ªça ƒë·ªô X
     * @param {number} y - T·ªça ƒë·ªô Y
     * @param {number} size - K√≠ch th∆∞·ªõc
     * @param {number} alpha - ƒê·ªô trong su·ªët
     * @param {number} hue - M√†u s·∫Øc (HSL)
     */
    drawHeartParticle(x, y, size, alpha, hue) {
        this.ctx.save();
        this.ctx.globalAlpha = alpha;
        this.ctx.fillStyle = `hsl(${hue}, 80%, 70%)`;
        this.ctx.shadowColor = `hsl(${hue}, 80%, 50%)`;
        this.ctx.shadowBlur = 4;

        // V·∫Ω h√¨nh tr√°i tim ƒë∆°n gi·∫£n
        this.ctx.beginPath();
        const heartSize = size * 0.5;
        this.ctx.moveTo(x, y + heartSize * 0.3);

        // ƒê∆∞·ªùng cong tr√°i
        this.ctx.bezierCurveTo(x, y, x - heartSize * 0.5, y, x - heartSize * 0.5, y + heartSize * 0.3);
        this.ctx.bezierCurveTo(x - heartSize * 0.5, y + heartSize * 0.5, x, y + heartSize * 0.7, x, y + heartSize * 0.9);

        // ƒê∆∞·ªùng cong ph·∫£i
        this.ctx.bezierCurveTo(x, y + heartSize * 0.7, x + heartSize * 0.5, y + heartSize * 0.5, x + heartSize * 0.5, y + heartSize * 0.3);
        this.ctx.bezierCurveTo(x + heartSize * 0.5, y, x, y, x, y + heartSize * 0.3);

        this.ctx.fill();
        this.ctx.restore();
    }

    /**
     * X·ª≠ l√Ω resize window
     */
    handleResize() {
        this.width = this.canvas.width = window.innerWidth;
        this.height = this.canvas.height = window.innerHeight;
    }

    /**
     * X√≥a t·∫•t c·∫£ ph√°o hoa
     */
    clear() {
        this.fireworks = [];
    }

    /**
     * D·ª´ng ho√†n to√†n hi·ªáu ·ª©ng
     */
    destroy() {
        this.stopAnimation();
        this.stopAutoCreate();
        this.clear();
        this.isInitialized = false;
        console.log('üéÜ Fireworks effect destroyed');
    }

    /**
     * T·∫°m d·ª´ng hi·ªáu ·ª©ng
     */
    pause() {
        this.stopAnimation();
        this.stopAutoCreate();
    }

    /**
     * Ti·∫øp t·ª•c hi·ªáu ·ª©ng
     */
    resume() {
        if (this.isInitialized) {
            this.startAnimation();
            if (this.autoCreate) {
                this.startAutoCreate();
            }
        }
    }

    /**
     * L·∫•y th√¥ng tin tr·∫°ng th√°i
     */
    getStatus() {
        return {
            isInitialized: this.isInitialized,
            fireworksCount: this.fireworks.length,
            totalParticles: this.fireworks.reduce((sum, fw) => sum + fw.particles.length, 0),
            isAnimating: this.animationId !== null,
            isAutoCreating: this.autoCreateInterval !== null
        };
    }
}

// T·∫°o instance global ƒë·ªÉ s·ª≠ d·ª•ng d·ªÖ d√†ng
window.FireworksEffect = FireworksEffect;

// Export cho module systems
if (typeof module !== 'undefined' && module.exports) {
    module.exports = FireworksEffect;
}
